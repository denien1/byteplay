<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BytePlay — Play</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="player">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <a class="btn" href="./">← Back</a>
      <span id="title" class="meta"></span>
      <div>
        <button class="btn" id="fullscreen">Fullscreen</button>
        <button class="btn" id="restart">Restart</button>
      </div>
    </div>
    <div id="msg" class="err"></div>
    <div class="canvas"><div id="game"></div></div>
  </div>

  <script>
    const params = new URL(location.href).searchParams;
    const id = params.get('id') || '';

    async function boot() {
      let meta = null;
      try {
        const res = await fetch('games.json', { cache: 'no-store' });
        const data = await res.json();
        meta = (data.games || []).find(g => g.id === id);
      } catch (e) {
        document.getElementById('msg').textContent = 'Failed to load games.json';
        console.error(e);
        return;
      }

      // BYOR — Bring Your Own ROM
      if (!meta && id === 'byor') {
        document.getElementById('title').textContent = 'Bring Your Own ROM';
        document.getElementById('msg').textContent = 'Choose a ROM file (.gba, .gbc, .gb, .sfc/.smc, .zip, .a26).';
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.gba,.gbc,.gb,.sfc,.smc,.nes,.zip,.a26';
        input.className = 'btn';
        input.style.margin = '10px 0';
        input.onchange = () => {
          const f = input.files?.[0];
          if (!f) return;
          // REQUIRED: set EJS_* BEFORE loading loader.js
          window.EJS_player     = '#game';
          window.EJS_core       = guessCore(f.name);
          window.EJS_gameUrl    = URL.createObjectURL(f);
          window.EJS_pathtodata = 'data/';
          console.log('EJS_core:', window.EJS_core);
          const s = document.createElement('script');
          s.src = 'data/loader.js';
          document.body.appendChild(s);
        };
        document.querySelector('.player').insertBefore(input, document.querySelector('.canvas'));
        wireToolbar();
        return;
      }

      if (!meta) {
        document.getElementById('msg').textContent = 'Game not found.';
        wireToolbar();
        return;
      }

      document.getElementById('title').textContent = meta.title || '';

      // REQUIRED: set EJS_* BEFORE loading loader.js
      window.EJS_player     = '#game';
      window.EJS_core       = meta.core;           // "gba" | "snes" | "fbneo" | "atari2600"
      window.EJS_gameUrl    = meta.rom;            // e.g., roms/neogeo/kof98.zip
      window.EJS_pathtodata = 'data/';             // contains loader.js and cores
      if (meta.bios) window.EJS_biosUrl = meta.bios; // e.g., roms/neogeo/neogeo.zip

      // Helpful debug logs (open DevTools Console to see)
      console.log('EJS_core:', window.EJS_core);
      console.log('EJS_gameUrl:', window.EJS_gameUrl);
      console.log('EJS_biosUrl:', window.EJS_biosUrl);
      console.log('EJS_pathtodata:', window.EJS_pathtodata);

      // Load the EmulatorJS loader AFTER the variables are set
      const s = document.createElement('script');
      s.src = 'data/loader.js';
      s.onerror = () => {
        document.getElementById('msg').textContent = 'Could not load data/loader.js — ensure the local data/ folder exists.';
      };
      document.body.appendChild(s);

      wireToolbar();
    }

    function wireToolbar() {
      document.getElementById('fullscreen').onclick = () => {
        const el = document.querySelector('.canvas');
        (el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen || (() => {})).call(el);
      };
      document.getElementById('restart').onclick = () => location.reload();
    }

    function guessCore(n) {
      n = n.toLowerCase();
      if (n.endsWith('.gba')) return 'gba';
      if (n.endsWith('.gbc')) return 'gbc';
      if (n.endsWith('.gb'))  return 'gb';
      if (n.endsWith('.sfc') || n.endsWith('.smc')) return 'snes';
      if (n.endsWith('.nes')) return 'nes';
      if (n.endsWith('.a26')) return 'atari2600';
      if (n.endsWith('.zip')) return 'fbneo'; // most arcade/Neo-Geo sets
      return 'gba';
    }

    boot();
  </script>
</body>
</html>
