<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BytePlay — Play</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="icon" href="assets/favicon.svg">
</head>
<body>
  <!-- particles background -->
  <div id="particles-js"></div>

  <div class="player-page container">
    <header class="header">
      <a class="brand" href="./" title="Return Home">
        <img src="assets/logo.svg" alt="BytePlay" />
        <div class="brand-text">
          <b class="brand-title">BytePlay</b>
          <small>Instant classics, in your browser.</small>
        </div>
      </a>
      <nav class="nav">
        <a class="btn ghost" href="./">Home</a>
        <a class="btn ghost" href="play.html?id=byor">Upload ROM</a>
        <a class="btn ghost" href="about.html">About</a>
        <a class="btn ghost" href="contact.html">Contact</a>
      </nav>
    </header>

    <div class="play-layout">
      <!-- left sidebar -->
      <aside class="sidebar" id="sidebar"></aside>

      <!-- main player -->
      <main class="play-main">
        <div class="toolbar">
          <span id="title" class="meta"></span>
          <div class="spacer"></div>
          <button class="btn" id="fullscreen">Fullscreen</button>
          <button class="btn" id="restart">Restart</button>
        </div>

        <!-- responsive player box (aspect ratio depends on system) -->
        <div class="emulator-wrap" id="emuWrap">
          <!-- emulator target -->
          <div id="game" aria-live="polite"></div>

          <!-- start overlay -->
          <div class="bp-overlay" id="startOverlay" role="dialog" aria-label="Start game">
            <button class="bp-playbtn" id="startBtn">
              <!-- play icon -->
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M8 5v14l11-7z"></path>
              </svg>
              <span class="play">Play</span>
              <span class="now">Now</span>
            </button>
          </div>

          <!-- loading overlay -->
          <div class="bp-overlay" id="loadingOverlay" role="status" aria-live="polite" hidden>
            <div class="bp-liquid-loader">
              <div class="bp-loader-track">
                <div class="bp-liquid-fill"></div>
              </div>
              <div class="bp-loading-text">
                Loading<span class="bp-dot">.</span><span class="bp-dot">.</span><span class="bp-dot">.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- details below player -->
        <section class="details" id="details"></section>
      </main>
    </div>

    <footer>© <a class="link" href="./">BytePlay</a></footer>
  </div>

  <script>
    const params = new URL(location.href).searchParams;
    const id = params.get('id') || '';

    let meta = null;
    let started = false;

    async function boot() {
      try {
        const res = await fetch('games.json', { cache: 'no-store' });
        const data = await res.json();
        // site excludes Neo Geo
        const cleaned = (data.games || []).filter(g => ['gba','snes','atari2600'].includes(g.system));
        meta = cleaned.find(g => g.id === id);
      } catch (e) {
        fail('Failed to load games.json'); console.error(e); return;
      }

      // BYOR
      if (!meta && id === 'byor') {
        document.getElementById('title').textContent = 'Bring Your Own ROM';
        renderSidebar({
          title: 'Bring Your Own ROM',
          cover: 'assets/byor-cover.svg',
          system: 'custom',
          year: '—',
          genre: '—',
          region: '—'
        });
        document.getElementById('details').innerHTML = `<h2>Load a ROM</h2><p>Select a ROM file (.gba, .gbc, .gb, .sfc/.smc, .nes, .a26, .zip). It runs fully in your browser.</p>`;
        setupAspectByCore('gba');

        // BYOR flow: on click, let user pick a file then start
        document.getElementById('startBtn').onclick = () => {
          const picker = document.createElement('input');
          picker.type = 'file';
          picker.accept = '.gba,.gbc,.gb,.sfc,.smc,.nes,.zip,.a26';
          picker.onchange = () => {
            const f = picker.files?.[0];
            if (!f) return;
            const core = guessCore(f.name);
            setupAspectByCore(core);
            begin({ core, romUrl: URL.createObjectURL(f) });
          };
          picker.click();
        };

        wireToolbar();
        return;
      }

      if (!meta) { fail('Game not found.'); wireToolbar(); return; }

      // UI
      document.getElementById('title').textContent = meta.title || '';
      renderSidebar(meta);
      renderDetails(meta);
      setupAspectByCore(meta.core);

      // Wire the start button to start the known game
      document.getElementById('startBtn').onclick = () => begin({
        core: meta.core,
        romUrl: meta.rom,
        biosUrl: meta.bios || null
      });

      wireToolbar();
    }

    function begin({ core, romUrl, biosUrl=null }){
      if (started) return;
      started = true;

      // Overlays
      document.getElementById('startOverlay').hidden = true;
      document.getElementById('loadingOverlay').hidden = false;

      // REQUIRED: set EJS_* BEFORE loading loader.js
      window.EJS_player      = '#game';
      window.EJS_core        = core;        // "gba" | "snes" | "atari2600"
      window.EJS_gameUrl     = romUrl;
      window.EJS_pathtodata  = 'data/';
      window.EJS_threads     = false;       // static hosting (GitHub Pages)
      if (biosUrl) window.EJS_biosUrl = biosUrl;

      // Load the EmulatorJS loader AFTER vars are set
      const s = document.createElement('script');
      s.src = 'data/loader.js';
      s.onerror = () => fail('Could not load data/loader.js — ensure /data exists and paths are correct.');
      document.body.appendChild(s);

      // Detect when emulator draws (iframe/canvas appears in #game)
      const target = document.getElementById('game');
      const obs = new MutationObserver(()=>{
        if (target.children.length > 0) {
          // Hide loader shortly after something appears
          setTimeout(()=> {
            document.getElementById('loadingOverlay').hidden = true;
            obs.disconnect();
          }, 300);
        }
      });
      obs.observe(target, { childList: true, subtree: true });

      // Safety timeout: hide loader after 10s even if observer misses
      setTimeout(()=> {
        if (!document.getElementById('loadingOverlay').hidden) {
          document.getElementById('loadingOverlay').hidden = true;
        }
      }, 10000);
    }

    function fail(msg){ document.getElementById('details').innerHTML = `<div class="err">${msg}</div>`; }

    function guessCore(n){
      n = n.toLowerCase();
      if (n.endsWith('.gba')) return 'gba';
      if (n.endsWith('.gbc')) return 'gbc';
      if (n.endsWith('.gb'))  return 'gb';
      if (n.endsWith('.sfc') || n.endsWith('.smc')) return 'snes';
      if (n.endsWith('.nes')) return 'nes';
      if (n.endsWith('.a26')) return 'atari2600';
      if (n.endsWith('.zip')) return 'gba'; // default zip to gba now that neogeo is removed
      return 'gba';
    }

    function setupAspectByCore(core){
      const wrap = document.getElementById('emuWrap');
      wrap.classList.remove('ar-3x2','ar-4x3');
      // GBA ~3:2 ; SNES/Atari ~4:3 (matching your site visuals)
      if (core === 'gba') wrap.classList.add('ar-3x2'); else wrap.classList.add('ar-4x3');
    }

    function renderSidebar(g){
      document.getElementById('sidebar').innerHTML = `
        <div class="side-card">
          <img class="side-cover" src="${g.cover}" alt="${g.title||'Game Cover'}">
          <h3 class="side-title">${g.title||'Untitled'}</h3>
          <div class="side-meta">${(g.system||'').toUpperCase()} • ${g.year||''}</div>
          <div class="side-meta">${g.genre||''} ${g.region?('• '+g.region):''}</div>
          <a class="btn wfull" href="./">Home</a>
        </div>`;
    }

    function renderDetails(g){
      document.getElementById('details').innerHTML = `
        <h2>${g.title}</h2>
        <p class="dim">${(g.system||'').toUpperCase()} • ${g.year||''} ${g.genre?('• '+g.genre):''} ${g.region?('• '+g.region):''}</p>
        ${g.description ? `<p>${g.description}</p>` : `<p>No description available.</p>`}
      `;
    }

    function wireToolbar(){
      document.getElementById('fullscreen').onclick = () => {
        const el = document.querySelector('#game').parentElement;
        (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||(()=>{})).call(el);
      };
      document.getElementById('restart').onclick = () => location.reload();
    }

    boot();
  </script>

  <!-- particles -->
  <script src="assets/particles.min.js"></script>
  <script>
    particlesJS.load('particles-js', 'assets/particles.json', ()=>console.log('particles loaded'));
  </script>

  <!-- Optional: wave the details title -->
  <script>
    (function(){
      const reduceMotion = matchMedia('(prefers-reduced-motion: reduce)').matches;
      function waveify(el){
        if(!el || el.classList.contains('wave-text')) return;
        const text = el.textContent.trim();
        el.textContent = '';
        el.classList.add('wave-text');
        const baseDelay = 0.06;
        [...text].forEach((ch,i)=>{
          const span = document.createElement('span');
          span.className = 'wave-char';
          span.textContent = ch;
          if(!reduceMotion) span.style.animationDelay = (i * baseDelay) + 's';
          el.appendChild(span);
        });
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        const h2 = document.querySelector('.details h2');
        if (h2) waveify(h2);
      });
    })();
  </script>
</body>
</html>
